name: Skill Code Review

on:
  issue_comment:
    types: [created]

jobs:
  check-trigger:
    # Only run on PR comments that mention @yetirobotics
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, '@yetirobotics')
    runs-on: ubuntu-latest
    outputs:
      authorized: ${{ steps.permission-check.outputs.authorized }}
      pr_number: ${{ steps.pr-info.outputs.pr_number }}
      pr_sha: ${{ steps.pr-info.outputs.pr_sha }}
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Check commenter write access
        id: permission-check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: perm } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login,
            });
            const level = perm.permission; // admin, write, read, none
            const authorized = level === 'admin' || level === 'write';
            console.log(`User ${context.payload.comment.user.login} has permission: ${level} â†’ authorized: ${authorized}`);
            core.setOutput('authorized', authorized.toString());

      - name: Get PR head SHA
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            core.setOutput('pr_number', context.issue.number.toString());
            core.setOutput('pr_sha', pr.head.sha);

  skill-review:
    needs: check-trigger
    if: needs.check-trigger.outputs.authorized == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.check-trigger.outputs.pr_sha }}

      - name: React to comment (acknowledge)
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes',
            });

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch action scripts and skills from main
        run: |
          git fetch origin main
          git checkout origin/main -- .github/actions/skill-review/ .agents/skills/

      - name: Install dependencies
        run: pip install -r .github/actions/skill-review/requirements.txt

      - name: Run skill review
        env:
          GRADIENT_API_KEY: ${{ secrets.GRADIENT_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKILLS_PATH: .agents/skills
          MODEL: openai-gpt-oss-120b
          FAIL_ON_CRITICAL: "true"
          PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
          GITHUB_REPO: ${{ github.repository }}
        run: python .github/actions/skill-review/review.py

      - name: React to comment (done)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: success ? 'rocket' : 'confused',
            });
